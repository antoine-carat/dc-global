<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <title>DC Global - A Hack4Stack project</title>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <link rel="stylesheet" href="main.css">
  <script src="vue.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
  <script src="datamaps.world.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Orbitron' rel='stylesheet' type='text/css'>
</head>
<body>
    <div id="app" >
      <div id="sidebar">
          <div id="sidebar_content">
              <h1><a href="/">DC Global</a></h1>
              <div id="icon">
                  <svg width="100" height="100">
                      <defs>
                          <pattern id="image" patternUnits="userSpaceOnUse" height="100" width="100">
                              <image id="image_url" x="0" y="0" height="100" width="100" xlink:href="40922-1-1.jpg"></image>
                          </pattern>
                      </defs>
                      <circle id='top' cx="50" cy="50" r="50" fill="url(#image)"/>
                  </svg>
              </div>
              <div>
                  <div id="datacenter"></div>
                  <div id="country"></div>
                  <div id="firstname"></div>
                  <div id="lastname"></div>
              </div>
          </div>
      </div>
      <div id="main">
          <div onclick="closeSidebar()" class="container">
              <div id="worldmap"></div>
          </div>
      </div>
  </div>
</body>
<script>
 var sidebar = false; // sidebar = true if sidebar is open
 var bubbleclicked = false; // true if a sidebar has just been clicked

 function openSidebar(data) {
   document.getElementById("sidebar").style.marginLeft = "0px";
   updateSidebar(data);
	 sidebar = true;
   console.log("open sidebar");
 }

 function closeSidebar() {
   if (bubbleclicked == false) {
     document.getElementById("sidebar").style.marginLeft = "-400px";
	   sidebar = false;
     console.log("close sidebar");
   };
   bubbleclicked = false;
 }

 function updateSidebar(data) {
   datacenter = data.id
   document.getElementById("datacenter").innerHTML = data.id
   document.getElementById("country").innerHTML = data.country

   var xmlhttp = new XMLHttpRequest();

   xmlhttp.onreadystatechange = function() {
     if (xmlhttp.readyState == XMLHttpRequest.DONE) {
       if (xmlhttp.status == 200) {
         var json = JSON.parse(xmlhttp.responseText);

         for (i = 0; i < json.length; i++ ) {
           if (json[i].city == data.id) {
             document.querySelector("image_url").setAttributeNS('/', 'xlink:href', json[i].last_name + ".jpg");
             document.getElementById("firstname").innerHTML = json[i].first_name;
             document.getElementById("lastname").innerHTML = json[i].last_name;
           };
         };
       }
       else if (xmlhttp.status == 400) {
         alert('There was an error 400');
       }
       else {
         alert('something else other than 200 was returned');
       }
     }
   };

   xmlhttp.open("GET", "/employees", true);
   xmlhttp.send();
 };

 var app = new Vue({
   el: '#app',
   data: {
     currentTime: "0:00:00",
     employees: [],
     datacenters: []
   },
   mounted() {
    this.startTime()
    axios.get('/datacenters')
      .then( response => {
        this.datacenters = response.data
        var map = new Datamap({
          element: document.getElementById('worldmap'),
          geographyConfig: {
            highlightOnHover: false,
            borderColor: 'rgb(44, 44, 44)',
            highlightFillColor: "blue"
          },
          fills: {
            HIGH: 'orange',
            LABEL: 'green',
            defaultFill: 'silver',
            highlightFillColor: 'blue'
          },
          data: {
            IRL: { fillKey: 'HIGH' },
            USA: { fillKey: 'HIGH' },
            AUS: { fillKey: 'HIGH' },
            IND: { fillKey: 'HIGH' }
          },
        });

        const DCS = this.datacenters.map( e => {
          return {
            ...e,
            radius: 20,
            fillKey: 'LABEL'
          }
        })

        axios.get('/employees')
          .then( response => {
            const EMPLOYEES = response.data;
            this.employees = EMPLOYEES
            console.log(DCS)
            map.bubbles(DCS, { popupTemplate: function (geo, data) {

              // console.log(data.timezone.gmtOffset);
              let d = new Date();
              let utc = d.getTime() + (d.getTimezoneOffset() * 60000);
              let nd = new Date((utc + data.timezone.gmtOffset * 1000)).toLocaleTimeString();

              setInterval(() => {
                let d = new Date();
                let utc = d.getTime() + (d.getTimezoneOffset() * 60000);
                let nd = new Date((utc + data.timezone.gmtOffset * 1000)).toLocaleTimeString();
                document.getElementById(`time-${data.id}`).innerHTML = "Local time: " + nd
              }, 500)

              let infoArray = ['<div class="hoverinfo">']
              
              EMPLOYEES.forEach((item, index) => {
                // Hack4Stack.start
                if (item.location == "Ireland") {
                  item.location = "Dublin, Ireland"
                }
                // Hack4Stack.end
                
                if (item.location.includes(data.id)) {
                  infoArray.push('<img src=' + item.last_name + '.jpg />')
                  infoArray.push('<br/>Name: ' + item.first_name + ' ' + item.last_name)
                }
              })
              infoArray.push('<br/>City: ' +  data.id + ', ' +  data.country),
              infoArray.push('<br/><span id="time-' + data.id +'">Local time: ' + nd),
              infoArray.push('</div>')

              // Iterate over employees to fill images and names

              return infoArray.join('');
            }});
          })
          .catch( error => {
            console.error(error)
          });
      })
      .catch( error => {
        console.error(error)
      });
   },
   methods: {
     startTime: function () {
       var today = new Date();
       var h = today.getHours();
       var m = today.getMinutes();
       var s = today.getSeconds();
       m = this.checkTime(m);
       s = this.checkTime(s);
       this.currentTime = h + ":" + m + ":" + s;
       var t = setTimeout(this.startTime, 500);
     },
     checkTime: function (i) {
       if (i < 10) {i = "0" + i};  // add zero in front of numbers < 10
       return i;
     }
   }
 })
</script>
</html>
