<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <title>DC Global - A Hack4Stack project</title>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <link rel="stylesheet" href="main.css">
  <script src="vue.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
  <script src="datamaps.world.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Orbitron' rel='stylesheet' type='text/css'>
</head>
<body>
    <div id="app" ref="foo">
      <div id="sidebar">
        <div id="sidebar_content">
          <h1></h1>
              <div id="icon">
                  <img id="sidebar_image" src="">
              </div>
              <div>
                  <div id="datacenter"></div>
                  <div id="country"></div>
                  <div id="firstname"></div>
                  <div id="lastname"></div>
              </div>
          </div>
      </div>
      <div id="main">
          <div @click="closeSidebar()" class="container">
              <div id="worldmap"></div>
          </div>
      </div>
  </div>
</body>
<script>

  var vueApp = new Vue({
    el: '#app',
    data: {
      currentTime: "0:00:00",
      sidebar: false,
      bubbleclicked: false,
      employees: [],
      datacenters: []
    },
    mounted() {
      this.startTime()
      axios.get('/datacenters')
        .then( response => {
          this.datacenters = response.data
          var map = new Datamap({
            element: document.getElementById('worldmap'),
            geographyConfig: {
              highlightOnHover: false,
              borderColor: 'rgb(44, 44, 44)',
              highlightFillColor: "blue"
            },
            fills: {
              HIGH: 'orange',
              LABEL: 'green',
              defaultFill: 'silver',
              highlightFillColor: 'blue'
            }
          });

          const DCS = this.datacenters.map( e => {
            return {
              ...e,
              radius: 20,
              fillKey: 'LABEL'
            }
          })

          map.updateChoropleth({
            //TODO: Fill this from DCS
            IRL: { fillKey: 'HIGH' },
            USA: { fillKey: 'HIGH' },
            AUS: { fillKey: 'HIGH' },
            IND: { fillKey: 'HIGH' }
          });

          axios.get('/employees')
            .then( response => {
              const EMPLOYEES = response.data;
              this.employees = EMPLOYEES
              map.bubbles(DCS, { popupTemplate: function (geo, data) {
                let d = new Date();
                let utc = d.getTime() + (d.getTimezoneOffset() * 60000);
                let nd = new Date((utc + data.timezone.gmtOffset * 1000)).toLocaleTimeString();

                let infoArray = ['<div class="hoverinfo">']

                // Iterate over employees to fill images and names
                EMPLOYEES.forEach((item, index) => {
                  // Hack4Stack.start
                  if (item.location == "Ireland") {
                    item.location = "Dublin, Ireland"
                  }
                  // Hack4Stack.end

                  if (item.location.includes(data.id)) {
                    infoArray.push('<img src=' + item.last_name + '.jpg />')
                    infoArray.push('<br/>Name: ' + item.first_name + ' ' + item.last_name)
                  }
                })
                infoArray.push('<br/>City: ' +  data.city + ', ' +  data.country),
                infoArray.push('<br/><span id="time-' + data.city +'">Local time: ' + nd),
                infoArray.push('</div>')

                return infoArray.join('');
              }});
            })
            .catch( error => {
              alert("SORRY, COULDN'T RETRIEVE EMPLOYEES DATA")
              console.error(error)
            });
        })
        .catch( error => {
          alert("SORRY, COULDN'T RETRIEVE DCS DATA")
          console.error(error)
        });
        this.startTime()
    },
    methods: {
      startTime: function () {
        var today = new Date();
        var h = today.getHours();
        var m = today.getMinutes();
        var s = today.getSeconds();
        m = this.checkTime(m);
        s = this.checkTime(s);
        this.currentTime = h + ":" + m + ":" + s;
        var t = setTimeout(this.startTime, 500);
      },
      checkTime: function (i) {
        if (i < 10) {i = "0" + i};  // add zero in front of numbers < 10
        return i;
      },
      updateSidebar: function (data) {
        datacenter = data.city
        document.getElementById("datacenter").innerHTML = data.city
        document.getElementById("country").innerHTML = data.country

        this.employees.forEach((item, index) => {
          // Hack4Stack.start
          if (item.location == "Ireland") {
            item.location = "Dublin, Ireland"
          }
          // Hack4Stack.end

          if (item.location.includes(data.id)) {
            document.getElementById("sidebar_image").src = item.last_name + ".jpg";
            document.getElementById("firstname").innerHTML = item.first_name;
            document.getElementById("lastname").innerHTML = item.last_name;
          }
        })
      },
      openSidebar: function (data, fromBubble) {
        if (this.sidebar == false) {
          document.getElementById("sidebar").style.marginLeft = "0px"
          this.sidebar = true
        }
        this.bubbleclicked = fromBubble
        this.updateSidebar(data)
      },
      closeSidebar: function () {
        if (this.bubbleclicked == false) {
          document.getElementById("sidebar").style.marginLeft = "-400px";
          this.sidebar = false;
        };
        this.bubbleclicked = false;
      }
    }
  })
</script>
</html>
