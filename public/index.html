<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <title>DC Global - A Hack4Stack project</title>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <link rel="stylesheet" href="main.css">
  <script src="vue.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
  <script src="datamaps.world.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Orbitron' rel='stylesheet' type='text/css'>
</head>
<body>
    <div id="app" ref="foo">
      <div id="sidebar">
        <div id="sidebar_content">
          <h1>{{ dc_engineer.city }}</h1>
              <div id="icon">
                  <img id="sidebar_image" :src="dc_engineer.image">
              </div>
              <div>
                {{ dc_engineer.name }}
              </div>
              </div>
          </div>
      </div>
      <div id="main">
          <div onclick="vueApp.closeSidebar()" class="container">
              <div id="worldmap"></div>
          </div>
      </div>
  </div>
</body>
<script>

  var vueApp = new Vue({
    el: '#app',
    data: {
      currentTime: "0:00:00",
      sidebar: false,
      bubbleclicked: false,
      employees: [],
      datacenters: [],
      dc_engineer: {
        city: "",
        country: "",
        image: "",
        name: ""
      }
    },
    mounted() {
      var map;
      this.startTime()
      axios.get('/datacenters')
        .then( response => {
          this.datacenters = response.data.map( e => {
            let radius;
            if (e.devices > 2000) {
              radius = 30
            } else if (e.devices > 1000) {
              radius = 25
            } else if (e.devices > 500) {
              radius = 15
            } else {
              radius = 10
            }
            return {
              ...e,
              radius,
              fillKey: 'ON'
            }
          })
          map = new Datamap({
            element: document.getElementById('worldmap'),
            geographyConfig: {
              highlightOnHover: false,
              borderColor: 'rgb(44, 44, 44)',
            },
            fills: {
              PRESENT: 'orange',
              ON: 'green',
              OFF: 'red',
              defaultFill: 'silver'
            }
          });
          let dc_codes = {}
          this.datacenters.forEach(e => {
            dc_codes[e.country_code3] = { fillKey: 'PRESENT' }
          })
          map.updateChoropleth(dc_codes);

          // TODO Pass employee ids from this.datacenter to /employees request.
          axios.get('/employees')
            .then( response => {
              const EMPLOYEES = response.data;
              this.employees = EMPLOYEES
              map.bubbles(this.datacenters, { popupTemplate: function (geo, data) {
                let d = new Date();
                let utc = d.getTime() + (d.getTimezoneOffset() * 60000);
                let nd = new Date((utc + data.timezone.gmtOffset * 1000)).toLocaleTimeString();

                let infoArray = ['<div class="hoverinfo">',
                                 'City: ' +  data.city + ', ' +  data.country,
                                 '<br/><span id="time-' + data.city +'">Local time: ' + nd + '</span>',
                                 '<br/>Engineers: <div class="engineers-box">']

                // Iterate over employees to fill images and names
                EMPLOYEES.forEach((item, index) => {
                  // Hack4Stack.start
                  if (item.location == "Ireland") {
                    // item.location = "Atlanta, US"
                    item.location = "Dublin, Ireland"
                  }
                  // Hack4Stack.end

                  if (item.location.includes(data.id)) {
                    infoArray.push('<img src=' + item.last_name + '.jpg />')
                  }
                })
                infoArray.push('</div>')
                infoArray.push('</div>')

                return infoArray.join('');
              }});
            })
            .catch( error => {
              alert("SORRY, COULDN'T RETRIEVE EMPLOYEES DATA")
              console.error(error)
            });
        })
        .catch( error => {
          alert("SORRY, COULDN'T RETRIEVE DCS DATA")
          console.error(error)
        });
        this.startTime()
        // setTimeout(() => {
        //   console.log("CHANGE")
        //   this.datacenters = this.datacenters.map( e => {
        //     return {
        //       ...e,
        //       fillKey: e.fillKey == 'ON' ? 'OFF' : 'ON'
        //     }
        //   })
        //   map.bubbles(this.datacenters)
        // }, 10000)
    },
    methods: {
      startTime: function () {
        var today = new Date();
        var h = today.getHours();
        var m = today.getMinutes();
        var s = today.getSeconds();
        m = this.checkTime(m);
        s = this.checkTime(s);
        this.currentTime = h + ":" + m + ":" + s;
        var t = setTimeout(this.startTime, 500);
      },
      checkTime: function (i) {
        if (i < 10) {i = "0" + i};  // add zero in front of numbers < 10
        return i;
      },
      updateSidebar: function (data) {
        // datacenter = data.city
        this.dc_engineer.city = data.city
        this.dc_engineer.country = data.country

        this.employees.forEach((item, index) => {
          // Hack4Stack.start
          if (item.location == "Ireland") {
            item.location = "Dublin, Ireland"
          }
          // Hack4Stack.end

          if (item.location.includes(data.id)) {
            this.dc_engineer.name = `${item.first_name} ${item.last_name}`
            this.dc_engineer.image = `${item.last_name}.jpg`;
          }
        })
        // console.log(this.dc_engineer)
      },
      openSidebar: function (data, fromBubble) {
        this.updateSidebar(data)
        // console.log(this.dc_engineer)

        if (!this.sidebar) {
          document.getElementById("sidebar").style.marginLeft = "0px"
          this.sidebar = true
        }
        this.bubbleclicked = fromBubble
      },
      closeSidebar: function () {
        if (!this.bubbleclicked){
          document.getElementById("sidebar").style.marginLeft = "-400px";
          this.sidebar = false;
        }
        this.bubbleclicked = false
      }
    }
  })
</script>
</html>
